<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Review Panel | Team Pixel Pirates</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230aa7c2'/><text x='50' y='60' font-size='48' text-anchor='middle' fill='white'>AI</text></svg>">
    <style>
        :root {
            --bg: #06121a;
            --bg-alt: #071b27;
            --card: rgba(255,255,255,0.08);
            --glass: rgba(255,255,255,0.14);
            --border: rgba(255,255,255,0.18);
            --white: #ecf7ff;
            --muted: #b8d9e6;
            --primary: #0aa7c2;
            --primary-2: #57d6ff;
            --accent: #0a6fd6;
            --success: #2fd598;
            --warning: #ff9800;
            --danger: #ff3d00;
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
        }

        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; }

        body {
            font-family: "Plus Jakarta Sans", system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, sans-serif;
            background: radial-gradient(1200px 700px at 10% -10%, #07324a 0%, transparent 60%),
                        radial-gradient(1200px 700px at 110% 10%, #06283d 0%, transparent 60%),
                        linear-gradient(180deg, #06121a 0%, #071b27 100%);
            color: var(--white);
            line-height: 1.6;
        }

        .header {
            position: sticky;
            top: 0;
            backdrop-filter: saturate(1.2) blur(10px);
            background: rgba(6,18,26,0.6);
            border-bottom: 1px solid var(--border);
            z-index: 40;
            padding: 14px 0;
        }

        .header-inner {
            width: min(1200px, 92%);
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .logo {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: conic-gradient(from 180deg, #0aa7c2, #0a6fd6, #57d6ff, #0aa7c2);
            box-shadow: 0 0 20px rgba(10,167,194,0.6);
        }

        .brand-text {
            display: flex;
            flex-direction: column;
        }

        .brand-top { font-weight: 700; letter-spacing: 0.2px; }
        .brand-bottom { font-size: 12px; color: var(--muted); }

        .nav {
            display: flex;
            gap: 18px;
            align-items: center;
        }

        .nav a {
            color: var(--muted);
            text-decoration: none;
            font-weight: 500;
        }

        .nav a:hover { color: var(--primary-2); }

        .container {
            width: min(1200px, 92%);
            margin: 30px auto;
            padding: 0 20px;
        }

        .panel-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .panel-title {
            font-size: 32px;
            margin: 0 0 10px;
            background: linear-gradient(135deg, var(--primary-2), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .panel-subtitle {
            color: var(--muted);
            font-size: 18px;
            margin: 0 0 20px;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .input-group label {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        .input-group input {
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.06);
            color: var(--white);
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10,167,194,0.2);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 18px;
            border-radius: 14px;
            border: 1px solid var(--border);
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.25s ease;
            backdrop-filter: blur(8px);
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            border-color: transparent;
            box-shadow: 0 10px 24px rgba(10,111,214,0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 30px rgba(10,111,214,0.45);
        }

        .btn-success { background: var(--success); border-color: var(--success); }
        .btn-warning { background: var(--warning); border-color: var(--warning); }
        .btn-danger { background: var(--danger); border-color: var(--danger); }

        .btn:hover { transform: translateY(-1px); }

        .consult-card {
            background: var(--glass);
            border: 1px solid var(--border);
            backdrop-filter: blur(12px);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .consult-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
        }

        .consult-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .patient-name {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
            color: var(--primary-2);
        }

        .consult-time {
            color: var(--muted);
            font-size: 14px;
        }

        .consult-section {
            margin-bottom: 16px;
        }

        .consult-label {
            font-weight: 600;
            color: var(--white);
            margin-bottom: 8px;
            display: block;
        }

        .consult-content {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            color: var(--white);
        }

        .consult-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .modify-section {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .modify-section.active {
            display: block;
        }

        .modify-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.06);
            color: var(--white);
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 12px;
        }

        .modify-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(10,167,194,0.2);
        }

        .modify-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .status.success {
            background: rgba(47,213,152,0.2);
            color: var(--success);
            border: 1px solid rgba(47,213,152,0.3);
        }

        .status.error {
            background: rgba(255,61,0,0.2);
            color: var(--danger);
            border: 1px solid rgba(255,61,0,0.3);
        }

        .status.info {
            background: rgba(10,167,194,0.2);
            color: var(--primary-2);
            border: 1px solid rgba(10,167,194,0.3);
        }

        .loading {
            text-align: center;
            color: var(--muted);
            font-size: 16px;
            padding: 40px;
        }

        .empty-state {
            text-align: center;
            color: var(--muted);
            padding: 60px 20px;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 12px;
            color: var(--primary-2);
        }

        .empty-state p {
            font-size: 16px;
            margin: 0;
        }

        .voice-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--primary-2);
            margin-left: 8px;
        }

        .voice-indicator.recording {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .consult-actions {
                flex-direction: column;
            }

            .modify-actions {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-inner">
            <div class="brand">
                <div class="logo"></div>
                <div class="brand-text">
                    <span class="brand-top">Team Pixel Pirates</span>
                    <span class="brand-bottom">Doctor Review Panel</span>
                </div>
            </div>
            <nav class="nav">
                <a href="index.html">Home</a>
                <a href="login.php">Login</a>
                <a href="signup.php">Sign Up</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="panel-header">
            <h1 class="panel-title">👨‍⚕️ Doctor Review Panel</h1>
            <p class="panel-subtitle">Review and approve AI chatbot medicine suggestions</p>
        </div>

        <div class="controls">
            <div class="input-group">
                <label for="doctorName">Doctor Name</label>
                <input type="text" id="doctorName" placeholder="Enter your name" />
            </div>
            <button class="btn btn-primary" onclick="fetchConsultations()">
                🔄 Refresh Consultations
            </button>
        </div>

        <div id="consultList" class="loading">Loading consultations...</div>
    </div>

    <script>
        // Configuration
        const API_BASE = "http://127.0.0.1:5000"; // FastAPI backend
        let doctorKey = "";
        let consultations = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            fetchConsultations();
        });

        // Fetch consultation list
        async function fetchConsultations() {
            const list = document.getElementById("consultList");
            list.innerHTML = '<div class="loading">Loading consultations...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/_list_recent`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                consultations = data;
                renderConsultations(data);
            } catch (error) {
                console.error('Error fetching consultations:', error);
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>⚠️ Connection Error</h3>
                        <p>Unable to connect to the backend server. Please check if the Flask server is running on ${API_BASE}</p>
                    </div>
                `;
            }
        }

        // Render consultations
        function renderConsultations(data) {
            const list = document.getElementById("consultList");
            
            if (!data || data.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <h3>📋 No Consultations</h3>
                        <p>No consultations are pending review at the moment.</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = "";
            data.forEach((consultation, index) => {
                const card = createConsultationCard(consultation, index);
                list.appendChild(card);
            });
        }

        // Create consultation card
        function createConsultationCard(consultation, index) {
            const card = document.createElement("div");
            card.className = "consult-card fade-in";
            card.style.animationDelay = `${index * 0.1}s`;
            
            const consultTime = new Date(consultation.created_at || Date.now()).toLocaleString();
            
            card.innerHTML = `
                <div class="consult-header">
                    <h3 class="patient-name">${consultation.patient_name || 'Anonymous Patient'}</h3>
                    <span class="consult-time">${consultTime}</span>
                </div>
                
                <div class="consult-section">
                    <label class="consult-label">📋 Symptoms</label>
                    <div class="consult-content">${consultation.symptoms || 'No symptoms provided'}</div>
                </div>
                
                <div class="consult-section">
                    <label class="consult-label">🤖 AI Recommendation</label>
                    <div class="consult-content">${consultation.chatbot_recommendation || 'No recommendation provided'}</div>
                </div>
                
                <div class="consult-actions">
                    <button class="btn btn-success" onclick="approveConsult('${consultation.id}')">
                        ✅ Approve
                    </button>
                    <button class="btn btn-warning" onclick="showModify('${consultation.id}')">
                        ✏️ Modify
                    </button>
                </div>
                
                <div id="modify-${consultation.id}" class="modify-section">
                    <label class="consult-label">💊 Doctor's Modification</label>
                    <textarea 
                        id="note-${consultation.id}" 
                        class="modify-textarea" 
                        placeholder="Type your medicine suggestion or modification here..."
                    ></textarea>
                    <div class="modify-actions">
                        <button class="btn btn-primary" onclick="sendModify('${consultation.id}')">
                            💾 Submit Modification
                        </button>
                        <button class="btn btn-warning" onclick="startVoice('${consultation.id}')">
                            🎤 Voice Input
                        </button>
                        <button class="btn" onclick="hideModify('${consultation.id}')">
                            ❌ Cancel
                        </button>
                    </div>
                </div>
                
                <div id="status-${consultation.id}" class="status" style="display: none;"></div>
            `;
            
            return card;
        }

        // Approve consultation
        async function approveConsult(id) {
            const doctorName = document.getElementById("doctorName").value || "Doctor";
            
            if (!doctorKey) {
                doctorKey = prompt("Enter your doctor access key:");
                if (!doctorKey) return;
            }

            try {
                const response = await fetch(`${API_BASE}/doctor_review`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-DOCTOR-KEY": doctorKey
                    },
                    body: JSON.stringify({
                        consult_id: id,
                        action: "approve",
                        doctor_name: doctorName
                    })
                });

                const result = await response.json();
                showStatus(id, result.message || "✅ Consultation approved successfully!", "success");
                
                // Remove the card after approval
                setTimeout(() => {
                    const card = document.querySelector(`[onclick*="approveConsult('${id}')"]`).closest('.consult-card');
                    if (card) {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(-20px)';
                        setTimeout(() => card.remove(), 300);
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Error approving consultation:', error);
                showStatus(id, "❌ Error approving consultation. Please try again.", "error");
            }
        }

        // Show modify section
        function showModify(id) {
            const modifySection = document.getElementById(`modify-${id}`);
            modifySection.classList.add('active');
            modifySection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Hide modify section
        function hideModify(id) {
            const modifySection = document.getElementById(`modify-${id}`);
            modifySection.classList.remove('active');
        }

        // Send modification
        async function sendModify(id) {
            const note = document.getElementById(`note-${id}`).value.trim();
            const doctorName = document.getElementById("doctorName").value || "Doctor";
            
            if (!note) {
                showStatus(id, "⚠️ Please enter your modification before submitting.", "error");
                return;
            }

            if (!doctorKey) {
                doctorKey = prompt("Enter your doctor access key:");
                if (!doctorKey) return;
            }

            try {
                const response = await fetch(`${API_BASE}/doctor_review`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-DOCTOR-KEY": doctorKey
                    },
                    body: JSON.stringify({
                        consult_id: id,
                        action: "modify",
                        doctor_name: doctorName,
                        doctor_note: note
                    })
                });

                const result = await response.json();
                showStatus(id, result.message || "✅ Modification submitted successfully!", "success");
                
                // Hide modify section
                hideModify(id);
                
            } catch (error) {
                console.error('Error submitting modification:', error);
                showStatus(id, "❌ Error submitting modification. Please try again.", "error");
            }
        }

        // Voice input for doctor suggestion
        function startVoice(id) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showStatus(id, "⚠️ Voice recognition not supported. Please use Chrome or Edge browser.", "error");
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.lang = "en-US";
            recognition.continuous = false;
            recognition.interimResults = false;

            const voiceBtn = document.querySelector(`[onclick*="startVoice('${id}')"]`);
            const originalText = voiceBtn.innerHTML;
            voiceBtn.innerHTML = '🎤 Listening...';
            voiceBtn.classList.add('recording');

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                const textarea = document.getElementById(`note-${id}`);
                textarea.value += (textarea.value ? " " : "") + text;
                showStatus(id, "🎤 Voice input captured!", "info");
            };

            recognition.onerror = function(event) {
                console.error('Voice recognition error:', event.error);
                showStatus(id, `❌ Voice recognition error: ${event.error}`, "error");
            };

            recognition.onend = function() {
                voiceBtn.innerHTML = originalText;
                voiceBtn.classList.remove('recording');
            };

            recognition.start();
        }

        // Show status message
        function showStatus(id, message, type) {
            const statusEl = document.getElementById(`status-${id}`);
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Auto-refresh every 30 seconds
        setInterval(fetchConsultations, 30000);
    </script>
</body>
</html>
